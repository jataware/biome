ImmPort is a database of clinical study and trial data generated by NIAID/DAIT-funded investigators.

It has a REST API that can be used to query the database. The API requires authentication. You will have access to the following environment variables:
    - `IMMPORT_USERNAME`
    - `IMMPORT_PASSWORD`

Here are some helper functions to authenticate with the API:

```python
import sys
import requests
import json
import platform
import pandas as pd
from io import StringIO

API_ENDPOINT_BASE_URL = "https://www.immport.org"
DATA_QUERY_URL = API_ENDPOINT_BASE_URL + "/data/query"
ASPERA_TOKEN_URL = API_ENDPOINT_BASE_URL + "/data/download/token"
IMMPORT_TOKEN_URL = "https://www.immport.org/auth/token"

username = os.environ.get("IMMPORT_USERNAME")
password = os.environ.get("IMMPORT_PASSWORD")


def request_immport_token(immport_token_url, username, password):
    '''Request an ImmPort token

    :param username: ImmPort user name.
    :param password: ImmPort user password.

    return immport_token
    '''
    r = requests.post(immport_token_url,
                data={'username': username, 'password': password})
    if r.status_code == 200:
        return r.json()['access_token']
    else:
        return None

def api_data_query(username, password, endpoint, immport_token_url, token=True, format="json"):
    '''Use the Data Query API by first checking ImmPort user credentials,
    retrieving an ImmPort token, then call the API endpoint to retrieve the results.

    param user_name: ImmPort username.
    param password: ImmPort password.
    param endpoint: Data Query endpoint
    param token: Indicates if endpoint requires a token
    param format: String (json, tsv)


    return: results or None
    '''
    headers = {}
    results = None

    if token:
        immport_token = request_immport_token(immport_token_url, username, password)
        if immport_token is None:
            print("ERROR: Credentials incorrect for ImmPort, unable to retrieve token", file = sys.stderr)
            return None
        if format == "json":
            headers = {
                'Authorization': "bearer " + immport_token,
                'Content-Type': "application/json"
            }
        else:
            headers = {
                'Authorization': "bearer " + immport_token,
                'Content-Type': "text/plain"
            }

    else:
        if format == "json":
            headers = {
                'Content-Type': "application/json"
            }
        else:
            headers = {
                'Content-Type': "text/plain"
            }

    results = requests.get(endpoint, headers=headers)
    if results.status_code == 200:
        if results is None:
            print("ERROR: API Endpoint failed to return results", file = sys.stderr)
            return None
        if format == "json":
            return results.json()
        else:
            return results.text
    else:
        print("ERROR: API Status Code: " + str(results.status_code), file = sys.stderr)
        return None
```

Here is an example of retrieving Pubmed information for SDY1 in JSON format:

```python
endpoint = DATA_QUERY_URL + "/api/study/pubmed/SDY1?format=json"
results = api_data_query(USERNAME, PASSWORD, endpoint, IMMPORT_TOKEN_URL, True, "json" )
df = pd.read_json(json.dumps(results))
df.head(2)
```

Here is an example of retrieving ELISA results in JSON format:

```python
endpoint = DATA_QUERY_URL + "/result/elisa?studyAccession=SDY1&format=json"
results = api_data_query(USERNAME, PASSWORD, endpoint, IMMPORT_TOKEN_URL, True, "json" )
print(json.dumps(results[0],indent=4))
df = pd.read_json(json.dumps(results))
df.head(2)
```    

Here is an example of retrieving LK_DISEASE:

```python
pd.set_option('max_colwidth', 200)
endpoint = DATA_QUERY_URL + "/api/lookup/lk_disease"
results = api_data_query(USERNAME, PASSWORD, endpoint, IMMPORT_TOKEN_URL, True, "json")
df = pd.read_json(json.dumps(results['content']), orient="columns")[['name','description','link']]
df.head(10)
```
