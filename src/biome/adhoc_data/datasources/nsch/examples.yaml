- query: "Check the existing columns in the dataset to see if the screentime variable and which geo columns are included."
  code: |
    import pandas as pd

    df_2023 = pd.read_sas("{{DATASET_FILES_BASE_PATH}}/census-nsch/2023e_topical.sas7bdat", format="sas7bdat")

    existing_cols = df_2023.columns.tolist()
    print(existing_cols)


- query: "Check the codebook columns head and available columns"
  code: |
    import pandas as pd

    # Read codebook with explicit parameters

    # Ensure index_col=FALSE, if not first column values disappear and the whole dataframe is shifted!
    codebook = pd.read_csv("{{DATASET_FILES_BASE_PATH}}/census-nsch/nsch_dictionary_codebook.csv", index_col=False)  
    # Display the first few rows
    print(codebook.head())

    # and columns if needed
    print(codebook.columns.tolist())

- query: "Retrieve health conditions reported in the National Survey of Children's Health, including ADHD, autism, and asthma."
  code: |
    import pandas as pd
    import numpy as np

    # Read the codebook
    codebook = pd.read_csv("{{DATASET_FILES_BASE_PATH}}/census-nsch/nsch_dictionary_codebook.csv", index_col=False)

    # Read 2023 data 
    df = pd.read_sas("{{DATASET_FILES_BASE_PATH}}/census-nsch/2023e_topical.sas7bdat", format="sas7bdat")

    # Find condition-related variables from codebook
    conditions = codebook[
        (codebook['Variable'].str.contains('adhd|autism|asth', case=False, na=False)) &
        (codebook['Source'] == 'Topical')
    ][['Variable', 'Question', 'Response Code']]

    # Get condition variables that exist in our dataset
    condition_vars = [var for var in conditions['Variable'] if var in df.columns]

    # Calculate prevalence for each condition
    results = []
    for var in condition_vars:
        condition_info = conditions[conditions['Variable'] == var].iloc[0]
        
        # Get counts and percentages
        counts = df[var].value_counts()
        total = counts.sum()
        percentages = (counts / total * 100).round(2)
        
        # Add to results
        results.append({
            'Condition': condition_info['Question'],
            'Total_Responses': total,
            'Yes_Count': counts.get(1, 0),  # Assuming 1 = Yes
            'Percentage': percentages.get(1, 0)
        })

    # Create results dataframe
    results_df = pd.DataFrame(results)
    results_df = results_df.sort_values('Percentage', ascending=False)

    print(results_df)


- query: "Analyze trends in childhood asthma and environmental factors over time (2016-2023) using NSCH data. Load multiple years of data, harmonize variables across years, and analyze the relationship between asthma prevalence and environmental factors like smoke exposure, housing insecurity, and food insecurity. Include state-level comparisons and create a composite environmental risk score. Do so specifically for Texas."
  code: |
    import pandas as pd
    import numpy as np
    import matplotlib.pyplot as plt
    import seaborn as sns
    import os
    from matplotlib.ticker import PercentFormatter

    # Set the path to the NSCH data directory
    nsch_dir = "{{DATASET_FILES_BASE_PATH}}/census-nsch/"

    # Function to load and prepare NSCH data for a specific year
    def load_nsch_data(year):
        # Load the dataset
        file_path = os.path.join(nsch_dir, f"{year}e_topical.sas7bdat")
        df = pd.read_sas(file_path)
        
        # Add year column
        df['year'] = year
        
        # Clean state FIPS codes
        df['FIPSST_clean'] = df['FIPSST'].astype(str).str.strip("b'").str.strip("'")
        
        # Create binary health condition variables
        df['has_asthma'] = np.where(df['K2Q40A'] == 1, 1, 0)
        
        # Create binary environmental factor variables if they exist in the dataset
        if 'K9Q41' in df.columns:
            df['smoke_inside'] = np.where(df['K9Q41'] == 1, 1, 0)
        
        if 'ACE1' in df.columns:
            df['housing_insecurity'] = np.where(df['ACE1'] >= 3, 1, 0)
        
        if 'FOODSIT' in df.columns:
            df['food_insecurity'] = np.where(df['FOODSIT'] >= 3, 1, 0)
        
        if 'TENURE' in df.columns:
            df['rented_housing'] = np.where(df['TENURE'] == 3, 1, 0)
        
        return df

    # Load data for all available years (2016-2023)
    years = range(2016, 2024)
    nsch_data_by_year = {}
    for year in years:
        try:
            nsch_data_by_year[year] = load_nsch_data(year)
            print(f"Loaded NSCH data for {year}: {len(nsch_data_by_year[year])} records")
        except Exception as e:
            print(f"Error loading data for {year}: {e}")

    # Create a mapping of FIPS codes to state names
    fips_to_state = {
        '01': 'Alabama', '02': 'Alaska', '04': 'Arizona', '05': 'Arkansas', '06': 'California',
        '08': 'Colorado', '09': 'Connecticut', '10': 'Delaware', '11': 'District of Columbia',
        '12': 'Florida', '13': 'Georgia', '15': 'Hawaii', '16': 'Idaho', '17': 'Illinois',
        '18': 'Indiana', '19': 'Iowa', '20': 'Kansas', '21': 'Kentucky', '22': 'Louisiana',
        '23': 'Maine', '24': 'Maryland', '25': 'Massachusetts', '26': 'Michigan', '27': 'Minnesota',
        '28': 'Mississippi', '29': 'Missouri', '30': 'Montana', '31': 'Nebraska', '32': 'Nevada',
        '33': 'New Hampshire', '34': 'New Jersey', '35': 'New Mexico', '36': 'New York',
        '37': 'North Carolina', '38': 'North Dakota', '39': 'Ohio', '40': 'Oklahoma', '41': 'Oregon',
        '42': 'Pennsylvania', '44': 'Rhode Island', '45': 'South Carolina', '46': 'South Dakota',
        '47': 'Tennessee', '48': 'Texas', '49': 'Utah', '50': 'Vermont', '51': 'Virginia',
        '53': 'Washington', '54': 'West Virginia', '55': 'Wisconsin', '56': 'Wyoming'
    }

    # 1. Analyze national trends in asthma prevalence over time
    asthma_trends = []
    for year, df in nsch_data_by_year.items():
        asthma_rate = df['has_asthma'].mean()
        asthma_trends.append({'Year': year, 'Asthma Rate': asthma_rate})

    asthma_trends_df = pd.DataFrame(asthma_trends)

    # Visualize national asthma trends
    plt.figure(figsize=(10, 6))
    sns.lineplot(x='Year', y='Asthma Rate', data=asthma_trends_df, marker='o', linewidth=2)
    plt.title('National Childhood Asthma Prevalence Trends (2016-2023)', fontsize=16)
    plt.xlabel('Year', fontsize=12)
    plt.ylabel('Proportion of Children with Asthma', fontsize=12)
    plt.grid(True, linestyle='--', alpha=0.7)
    plt.gca().yaxis.set_major_formatter(PercentFormatter(1.0))
    plt.tight_layout()
    plt.savefig('national_asthma_trends.png')
    plt.close()

    # 2. Analyze state-level asthma trends for selected states
    # Select a few states for comparison (including Texas)
    selected_states = ['Texas', 'California', 'New York', 'Florida', 'Illinois']
    selected_fips = [k for k, v in fips_to_state.items() if v in selected_states]

    state_trends = []
    for year, df in nsch_data_by_year.items():
        # Add state names
        df['State'] = df['FIPSST_clean'].map(fips_to_state)
        
        # Calculate asthma rates by state
        state_asthma = df.groupby('State')['has_asthma'].mean().reset_index()
        state_asthma['Year'] = year
        
        # Filter for selected states
        selected_state_data = state_asthma[state_asthma['State'].isin(selected_states)]
        state_trends.append(selected_state_data)

    state_trends_df = pd.concat(state_trends)

    # Visualize state-level asthma trends
    plt.figure(figsize=(12, 7))
    sns.lineplot(x='Year', y='has_asthma', hue='State', data=state_trends_df, marker='o', linewidth=2)
    plt.title('Childhood Asthma Prevalence Trends by State (2016-2023)', fontsize=16)
    plt.xlabel('Year', fontsize=12)
    plt.ylabel('Proportion of Children with Asthma', fontsize=12)
    plt.grid(True, linestyle='--', alpha=0.7)
    plt.gca().yaxis.set_major_formatter(PercentFormatter(1.0))
    plt.legend(title='State', bbox_to_anchor=(1.05, 1), loc='upper left')
    plt.tight_layout()
    plt.savefig('state_asthma_trends.png')
    plt.close()

    # 3. Analyze the relationship between environmental factors and asthma over time
    # Focus on smoke exposure inside the home
    smoke_asthma_trends = []
    for year, df in nsch_data_by_year.items():
        if 'smoke_inside' in df.columns:
            # Calculate asthma rates by smoke exposure
            smoke_yes_rate = df[df['smoke_inside'] == 1]['has_asthma'].mean()
            smoke_no_rate = df[df['smoke_inside'] == 0]['has_asthma'].mean()
            
            smoke_asthma_trends.append({
                'Year': year,
                'Smoke Exposure': 'Yes',
                'Asthma Rate': smoke_yes_rate
            })
            smoke_asthma_trends.append({
                'Year': year,
                'Smoke Exposure': 'No',
                'Asthma Rate': smoke_no_rate
            })

    smoke_asthma_df = pd.DataFrame(smoke_asthma_trends)

    # Visualize the relationship between smoke exposure and asthma over time
    plt.figure(figsize=(12, 7))
    sns.lineplot(x='Year', y='Asthma Rate', hue='Smoke Exposure', data=smoke_asthma_df, marker='o', linewidth=2)
    plt.title('Childhood Asthma Rates by Smoke Exposure Inside Home (2016-2023)', fontsize=16)
    plt.xlabel('Year', fontsize=12)
    plt.ylabel('Proportion of Children with Asthma', fontsize=12)
    plt.grid(True, linestyle='--', alpha=0.7)
    plt.gca().yaxis.set_major_formatter(PercentFormatter(1.0))
    plt.legend(title='Smoke Inside Home', bbox_to_anchor=(1.05, 1), loc='upper left')
    plt.tight_layout()
    plt.savefig('smoke_asthma_trends.png')
    plt.close()

    # 4. Analyze the combined effect of multiple environmental factors on asthma
    # Create a risk score based on the number of environmental risk factors
    # For the most recent year (2023)
    recent_data = nsch_data_by_year[2023]

    # Create a risk score (0-4) based on the number of environmental risk factors
    env_factors = ['smoke_inside', 'housing_insecurity', 'food_insecurity', 'rented_housing']
    for factor in env_factors:
        if factor not in recent_data.columns:
            recent_data[factor] = 0  # Default to 0 if the column doesn't exist

    recent_data['env_risk_score'] = recent_data[env_factors].sum(axis=1)

    # Calculate asthma rates by risk score
    risk_asthma = recent_data.groupby('env_risk_score')['has_asthma'].mean().reset_index()
    risk_asthma['env_risk_score'] = risk_asthma['env_risk_score'].astype(str)

    # Visualize asthma rates by environmental risk score
    plt.figure(figsize=(10, 6))
    sns.barplot(x='env_risk_score', y='has_asthma', data=risk_asthma, palette='viridis')
    plt.title('Asthma Rates by Number of Environmental Risk Factors (2023)', fontsize=16)
    plt.xlabel('Number of Environmental Risk Factors', fontsize=12)
    plt.ylabel('Proportion of Children with Asthma', fontsize=12)
    plt.grid(True, linestyle='--', alpha=0.7, axis='y')
    plt.gca().yaxis.set_major_formatter(PercentFormatter(1.0))

    # Add the actual percentages as text on the bars
    for i, p in enumerate(plt.gca().patches):
        height = p.get_height()
        plt.text(p.get_x() + p.get_width()/2., height + 0.005, f'{height:.1%}',
                ha='center', fontsize=12)

    plt.tight_layout()
    plt.savefig('asthma_by_risk_score.png')
    plt.close()

    # 5. Create a summary table of findings
    print("Summary of Findings:")
    print(f"1. National Asthma Trend: The childhood asthma rate {'increased' if asthma_trends_df.iloc[-1]['Asthma Rate'] > asthma_trends_df.iloc[0]['Asthma Rate'] else 'decreased'} from {asthma_trends_df.iloc[0]['Asthma Rate']:.1%} in 2016 to {asthma_trends_df.iloc[-1]['Asthma Rate']:.1%} in 2023.")

    # Calculate the average difference in asthma rates between children exposed to smoke and those not exposed
    avg_diff = smoke_asthma_df[smoke_asthma_df['Smoke Exposure'] == 'Yes']['Asthma Rate'].mean() - smoke_asthma_df[smoke_asthma_df['Smoke Exposure'] == 'No']['Asthma Rate'].mean()
    print(f"2. Smoke Exposure Impact: Children exposed to smoke inside the home had on average {avg_diff:.1%} higher asthma rates compared to those not exposed.")

    # Calculate the ratio of asthma rates for highest vs. lowest risk scores
    if len(risk_asthma) > 1:
        highest_risk = risk_asthma['has_asthma'].max()
        lowest_risk = risk_asthma['has_asthma'].min()
        risk_ratio = highest_risk / lowest_risk
        print(f"3. Environmental Risk Factors: Children with the highest number of environmental risk factors were {risk_ratio:.1f}x more likely to have asthma compared to those with the lowest number of risk factors.")

    # Texas-specific findings
    texas_data = state_trends_df[state_trends_df['State'] == 'Texas']
    texas_trend = 'increased' if texas_data.iloc[-1]['has_asthma'] > texas_data.iloc[0]['has_asthma'] else 'decreased'
    print(f"4. Texas Trends: The childhood asthma rate in Texas {texas_trend} from {texas_data.iloc[0]['has_asthma']:.1%} in 2016 to {texas_data.iloc[-1]['has_asthma']:.1%} in 2023.")
