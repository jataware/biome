- query: "Get columns available in IDC index"
  code: |
    from idc_index import index
    import pandas as pd

    client = index.IDCClient()

    # First, let's see what columns are available
    query_columns = """
    SELECT * FROM index LIMIT 1
    """

    try:
        df = client.sql_query(query_columns)
        print("Available columns in the index:")
        print(df.columns.tolist())
    except Exception as e:
        print(f"An error occurred: {str(e)}")

- query: "Get slide microscopy data"
  code: |
    from idc_index import index
    import pandas as pd

    client = index.IDCClient()

    # Query for slide microscopy data
    query = """
    SELECT DISTINCT
        collection_id,
        PatientID,
        SeriesDescription,
        StudyDescription,
        BodyPartExamined,
        SeriesDate
    FROM
        index
    WHERE
        Modality = 'SM'
    """

    try:
        df = client.sql_query(query)
        print("Slide Microscopy Data Available:")
        print("\nCollections with slide microscopy data:")
        print(df['collection_id'].unique())
        print("\nSample of the data:")
        print(df.head())
        print("\nTotal number of records:", len(df))
    except Exception as e:
        print(f"An error occurred: {str(e)}")
    
- query: "Get slide microscopy data for a specific collection"
  code: |
    from idc_index import index
    import pandas as pd

    client = index.IDCClient()

    # Query for AML-specific slide microscopy data
    query = """
    SELECT DISTINCT
        collection_id,
        PatientID,
        SeriesDescription,
        StudyDescription,
        BodyPartExamined,
        SeriesDate,
        Manufacturer,
        ManufacturerModelName,
        SeriesNumber,
        instanceCount
    FROM
        index
    WHERE
        Modality = 'SM'
        AND collection_id IN ('cptac_aml', 'cmb_aml')
    ORDER BY
        PatientID, SeriesDate
    """

    try:
        df = client.sql_query(query)
        print("AML Slide Microscopy Data:")
        print("\nTotal number of records:", len(df))

        print("\nUnique patients:", len(df['PatientID'].unique()))

        print("\nTypes of series descriptions (slide types):")
        print(df['SeriesDescription'].unique())

        print("\nSample of the data:")
        print(df.head(10))

        # Save to a CSV file for further analysis
        df.to_csv('aml_pathology_data.csv', index=False)
        print("\nData has been saved to 'aml_pathology_data.csv'")

    except Exception as e:
        print(f"An error occurred: {str(e)}")   

- query: "Get additional information for microscopy data for a specific collection"
  code: |
    from idc_index import index
    import pandas as pd

    client = index.IDCClient()

    # Query for all available fields for AML slides
    query = """
    SELECT *
    FROM
        index
    WHERE
        Modality = 'SM'
        AND collection_id IN ('cptac_aml', 'cmb_aml')
        AND SeriesDescription LIKE '%bone marrow%'
    ORDER BY
        PatientID, SeriesDate
    """

    try:
        df = client.sql_query(query)
        print("AML Bone Marrow Slide Data:")
        print("\nTotal number of bone marrow slides:", len(df))

        print("\nAvailable columns (metadata fields):")
        print(df.columns.tolist())

        # Look for any columns that might contain annotations or clinical data
        clinical_cols = [col for col in df.columns if any(term in col.lower() 
                                                        for term in ['annotation', 'clinical', 'blast', 'cell', 
                                                                   'pathology', 'diagnosis', 'grade', 'stage'])]
        print("\nPotentially relevant clinical/annotation columns:")
        print(clinical_cols)

        # Get the source DOIs which might lead to additional clinical data
        print("\nUnique source DOIs (for finding additional clinical data):")
        print(df['source_DOI'].unique())

    except Exception as e:
        print(f"An error occurred: {str(e)}")

    # Let's also check if there are any study-level annotations
    query_study = """
    SELECT DISTINCT
        StudyDescription,
        collection_id,
        source_DOI,
        license_short_name
    FROM
        index
    WHERE
        collection_id IN ('cptac_aml', 'cmb_aml')
    """

    try:
        df_study = client.sql_query(query_study)
        print("\nStudy-level information:")
        print(df_study)
    except Exception as e:
        print(f"An error occurred querying study data: {str(e)}")

- query: "Query to get download URLs for bone marrow slides"
  code: |
    from idc_index import index
    import pandas as pd

    client = index.IDCClient()

    # Query to get download URLs for bone marrow slides
    query = """
    SELECT
        PatientID,
        SeriesDescription,
        series_aws_url,
        series_size_MB
    FROM
        index
    WHERE
        Modality = 'SM'
        AND collection_id IN ('cptac_aml', 'cmb_aml')
        AND SeriesDescription LIKE '%bone marrow%'
    LIMIT 1
    """

    try:
        df = client.sql_query(query)
        print("Sample slide information:")
        print(df)
        
        if not df.empty:
            url = df['series_aws_url'].iloc[0]
            size_mb = df['series_size_MB'].iloc[0]
            print(f"\nFile size: {size_mb:.2f} MB")
            print(f"Download URL: {url}")
    except Exception as e:
        print(f"An error occurred: {str(e)}")

- query: "Get list of files in an S3 bucket for a specific collection on IDC"
  code: |
    import boto3
    from botocore import UNSIGNED
    from botocore.config import Config
    import os
    import tempfile

    # Function to list contents of an S3 path
    def list_s3_contents(bucket, prefix):
        s3 = boto3.client('s3', config=Config(signature_version=UNSIGNED))
        try:
            result = s3.list_objects_v2(Bucket=bucket, Prefix=prefix)
            if 'Contents' in result:
                return result['Contents']
            return []
        except Exception as e:
            print(f"Error listing S3 contents: {str(e)}")
            return []

    # Parse S3 URL and list contents
    s3_url = "s3://idc-open-data/d53e7fc3-8ef9-4de5-8059-47b21a67eb4f"
    bucket = s3_url.split('/')[2]
    prefix = '/'.join(s3_url.split('/')[3:])

    print(f"Checking contents of bucket: {bucket}")
    print(f"With prefix: {prefix}")

    contents = list_s3_contents(bucket, prefix)
    print("\nFound files:")
    for item in contents:
        print(f"- {item['Key']} ({item['Size']/1024/1024:.2f} MB)")

    # Let's also check if we can get any pre-signed URLs or public access URLs
    s3 = boto3.client('s3', config=Config(signature_version=UNSIGNED))
    try:
        # Try to get the bucket location
        location = s3.get_bucket_location(Bucket=bucket)
        print(f"\nBucket location: {location}")

        # Try to get bucket policy
        try:
            policy = s3.get_bucket_policy(Bucket=bucket)
            print("\nBucket policy:", policy)
        except Exception as e:
            print("\nCouldn't get bucket policy:", str(e))

    except Exception as e:
        print(f"\nError getting bucket information: {str(e)}")

- query: "Download and visualize a slide microscopy image with pydicom and matplotlib"
  code: |
    import sys
    import subprocess

    # Install required package
    subprocess.check_call([sys.executable, "-m", "pip", "install", "pydicom"])

    import boto3
    from botocore import UNSIGNED
    from botocore.config import Config
    import os
    import tempfile
    import pydicom
    from PIL import Image
    import numpy as np
    import matplotlib.pyplot as plt

    # Create S3 client
    s3 = boto3.client('s3', config=Config(signature_version=UNSIGNED))

    # Create temporary directory
    temp_dir = tempfile.mkdtemp()

    # Let's try the smallest DICOM file first
    file_key = "d53e7fc3-8ef9-4de5-8059-47b21a67eb4f/40006642-6ee5-44ca-bc5f-e1cc2bd7ee70.dcm"
    local_file = os.path.join(temp_dir, "slide.dcm")

    try:
        print(f"Downloading file: {file_key}")
        s3.download_file('idc-open-data', file_key, local_file)
        print("Download successful!")

        # Try to read the DICOM file
        print("\nReading DICOM file...")
        ds = pydicom.dcmread(local_file)

        print("\nDICOM metadata:")
        print(f"Patient ID: {ds.PatientID}")
        print(f"Modality: {ds.Modality}")
        print(f"Image Type: {ds.ImageType}")

        # Convert to image and display
        if hasattr(ds, 'pixel_array'):
            print("\nConverting to image...")
            pixel_array = ds.pixel_array

            # Normalize the pixel values
            if pixel_array.dtype != np.uint8:
                pixel_array = ((pixel_array - pixel_array.min()) * 255.0 / 
                             (pixel_array.max() - pixel_array.min())).astype(np.uint8)

            # Create image
            img = Image.fromarray(pixel_array)

            # Display
            plt.figure(figsize=(15, 10))
            plt.imshow(img, cmap='gray')
            plt.axis('off')
            plt.title(f"DICOM Image - Patient: {ds.PatientID}")
            plt.show()
        else:
            print("No pixel data found in the DICOM file")

    except Exception as e:
        print(f"An error occurred: {str(e)}")
    finally:
        # Clean up
        if os.path.exists(local_file):
            os.remove(local_file)
        os.rmdir(temp_dir)


- query: "Find collections in the Imaging Data Commons with 'aml' in their name, likely related to Acute Myeloid Leukemia."
  code: |
    from idc_index import index
    import pandas as pd

    client = index.IDCClient()

    # Query to find collection names containing 'aml'
    query = """
    SELECT DISTINCT collection_id
    FROM 
        index
    WHERE 
        LOWER(collection_id) LIKE '%aml%'
    """

    try:
        df_collections = client.sql_query(query)
        print("Collections with 'aml' in their name:")
        print(df_collections)
    except Exception as e:
        print(f"An error occurred: {str(e)}")

- query: "Download bone marrow biopsy images from the 'cmb_aml' collection for a specific study using IDC's public S3 bucket."
  code: |
    import pandas as pd
    from idc_index import index

    client = index.IDCClient()

    # Query for the desired images
    query = """
    SELECT series_aws_url
    FROM index
    WHERE collection_id = 'cmb_aml'
    AND StudyDescription = 'XR_Biopsy_BoneMarrow'
    """
    df = client.sql_query(query)

    # Create a download manifest using the current directory
    with open('download_manifest.txt', 'w') as f:
        for url in df['series_aws_url']:
            f.write(f'cp {url} ./\n')

    # Execute the download
    s5cmd_binary = client.s5cmdPath
    !{s5cmd_binary} --no-sign-request --endpoint-url https://s3.amazonaws.com run download_manifest.txt

- query: "Basic plot of dicom image from file"
  code: |
    import pydicom
    import matplotlib.pyplot as plt

    # Load the DICOM file
    filename = '73f18e49-8699-4c1f-90ad-5db94b6b5602.dcm'
    ds = pydicom.dcmread(filename)

    # Display the image
    plt.imshow(ds.pixel_array, cmap=plt.cm.gray)
    plt.title('Bone Marrow Biopsy Image')
    plt.axis('off')
    plt.show()

- query: "List all studies for a given collection"
  code: |
    # Query to list all studies in the 'cmb_aml' collection
    query_all_studies = """
    SELECT DISTINCT StudyDescription
    FROM 
        index
    WHERE 
        collection_id = 'cmb_aml'
    """

    try:
        df_all_studies = client.sql_query(query_all_studies)
        print("All studies in the 'cmb_aml' collection:")
        print(df_all_studies)
    except Exception as e:
        print(f"An error occurred: {str(e)}")

- query: "Retrieve imagery URLs for the 'XR_Biopsy_BoneMarrow' study in the 'cmb_aml' collection from IDC."
  code: |
    import pandas as pd
    from idc_index import index

    client = index.IDCClient()

    query = """
    SELECT series_aws_url
    FROM index
    WHERE collection_id = 'cmb_aml'
    AND StudyDescription = 'XR_Biopsy_BoneMarrow'
    """
    df = client.sql_query(query)
    print(df.head())

- query: "Fetch studies for a given collection in the Imaging Data Commons (IDC), specifically for the 'cptac_aml' collection."
  code: |
    from idc_index import index
    import pandas as pd

    # Initialize the IDC client
    client = index.IDCClient()

    # Query to find studies within the 'cptac_aml' collection
    query = """
    SELECT DISTINCT StudyDescription
    FROM 
        index
    WHERE 
        collection_id = 'cptac_aml'
    """

    try:
        # Execute the query
        df_studies = client.sql_query(query)
        print("Studies in 'cptac_aml':")
        print(df_studies)
    except Exception as e:
        print(f"An error occurred: {str(e)}")
    